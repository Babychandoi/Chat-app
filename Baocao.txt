# BÃO CÃO á»¨NG Dá»¤NG CHAT P2P
## Real-time Event-Driven Communication vá»›i Voice/Video Call

---

## 1. Tá»”NG QUAN Dá»° ÃN

### 1.1. Giá»›i thiá»‡u
á»¨ng dá»¥ng Chat P2P lÃ  má»™t há»‡ thá»‘ng nháº¯n tin ngang hÃ ng (peer-to-peer) Ä‘Æ°á»£c phÃ¡t triá»ƒn báº±ng Java vÃ  JavaFX, cho phÃ©p ngÆ°á»i dÃ¹ng giao tiáº¿p trá»±c tiáº¿p vá»›i nhau qua máº¡ng LAN mÃ  khÃ´ng cáº§n mÃ¡y chá»§ trung gian. á»¨ng dá»¥ng há»— trá»£ nháº¯n tin vÄƒn báº£n, chia sáº» file, táº¡o nhÃ³m chat, vÃ  Ä‘áº·c biá»‡t lÃ  tÃ­nh nÄƒng gá»i thoáº¡i/video call.

### 1.2. Má»¥c tiÃªu
- XÃ¢y dá»±ng há»‡ thá»‘ng chat P2P hoáº¡t Ä‘á»™ng trÃªn máº¡ng LAN
- Triá»ƒn khai kiáº¿n trÃºc event-driven Ä‘á»ƒ xá»­ lÃ½ real-time
- Há»— trá»£ Ä‘a phÆ°Æ¡ng thá»©c giao tiáº¿p: text, file, voice, video
- Quáº£n lÃ½ nhÃ³m chat vá»›i nhiá»u thÃ nh viÃªn
- Giao diá»‡n ngÆ°á»i dÃ¹ng thÃ¢n thiá»‡n, hiá»‡n Ä‘áº¡i

### 1.3. CÃ´ng nghá»‡ sá»­ dá»¥ng
- **NgÃ´n ngá»¯**: Java 17
- **GUI Framework**: JavaFX 17.0.2
- **Video Capture**: Webcam Capture API (Sarxos 0.3.12)
- **Audio**: Java Sound API (vá»›i auto-format detection)
- **Networking**: Java Socket Programming
- **Concurrency**: Java Concurrent Collections, ExecutorService, AtomicBoolean
- **Build Tool**: Maven
- **Dependencies**: Gson, SLF4J

---

## 2. KIáº¾N TRÃšC Há»† THá»NG

### 2.1. MÃ´ hÃ¬nh tá»•ng quan
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   P2P Chat Application                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ AuthManager  â”‚  â”‚ ChatManager  â”‚  â”‚ CallManager  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                  â”‚                  â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                           â”‚                              â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚                  â”‚ MainController  â”‚                     â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                           â”‚                              â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚         â”‚                 â”‚                 â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Network    â”‚   â”‚   Voice   â”‚   â”‚    Video    â”‚     â”‚
â”‚  â”‚  Manager    â”‚   â”‚   Call    â”‚   â”‚    Call     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  Manager  â”‚   â”‚   Manager   â”‚     â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2. CÃ¡c thÃ nh pháº§n chÃ­nh

#### 2.2.1. MainController
- Äiá»u phá»‘i toÃ n bá»™ á»©ng dá»¥ng
- Quáº£n lÃ½ vÃ²ng Ä‘á»i cá»§a cÃ¡c component
- Xá»­ lÃ½ login success vÃ  khá»Ÿi táº¡o há»‡ thá»‘ng

#### 2.2.2. AuthManager
- XÃ¡c thá»±c ngÆ°á»i dÃ¹ng (login/register)
- LÆ°u trá»¯ thÃ´ng tin tÃ i khoáº£n trong file `users.txt` (format: username:password)
- Giao diá»‡n Ä‘Äƒng nháº­p/Ä‘Äƒng kÃ½ hiá»‡n Ä‘áº¡i vá»›i gradient background
- TÃ­ch há»£p SessionLockManager Ä‘á»ƒ ngÄƒn Ä‘Äƒng nháº­p trÃ¹ng láº·p

#### 2.2.3. ChatManager
- Quáº£n lÃ½ giao diá»‡n chat chÃ­nh vá»›i modern UI
- Hiá»ƒn thá»‹ danh sÃ¡ch contacts vÃ  nhÃ³m (vá»›i online indicators)
- Xá»­ lÃ½ gá»­i/nháº­n tin nháº¯n text vÃ  file
- Image preview cho file áº£nh (double-click Ä‘á»ƒ xem full size)
- Typing indicators (1-1 vÃ  nhÃ³m)
- Load/save chat history (format: [timestamp] sender: message)
- Táº¡o vÃ  quáº£n lÃ½ nhÃ³m chat (thÃªm/xÃ³a thÃ nh viÃªn, rá»i nhÃ³m)

#### 2.2.4. NetworkManager
- **Discovery Server** (Port 11000-11049): Tá»± Ä‘á»™ng phÃ¡t hiá»‡n peers trÃªn LAN
  - Scan thÃ´ng minh: Ping trÆ°á»›c Ä‘á»ƒ tÃ¬m active hosts, sau Ä‘Ã³ scan discovery ports
  - Chá»‰ scan 50 ports (11000-11049) thay vÃ¬ 1000 ports Ä‘á»ƒ tá»‘i Æ°u tá»‘c Ä‘á»™
  - Peer notification: Tá»± Ä‘á»™ng thÃ´ng bÃ¡o peer má»›i cho cÃ¡c peer hiá»‡n cÃ³
- **Chat Server** (Port Ä‘á»™ng: 8888-9887): Nháº­n káº¿t ná»‘i chat tá»« peers
- **File Server** (Port Ä‘á»™ng: 8890-9889): Xá»­ lÃ½ truyá»n file
- Quáº£n lÃ½ káº¿t ná»‘i P2P vá»›i cÃ¡c peer (PeerConnection)
- Äá»“ng bá»™ hÃ³a nhÃ³m chat giá»¯a cÃ¡c thÃ nh viÃªn (GROUP_SYNC)
- Routing messages (direct, group, file, typing indicators)
- Heartbeat checker: Kiá»ƒm tra peer offline Ä‘á»‹nh ká»³ (10s)

#### 2.2.5. CallManager
- Quáº£n lÃ½ UI cá»§a voice/video call
- Äiá»u phá»‘i giá»¯a VoiceCallManager vÃ  VideoCallManager
- Hiá»ƒn thá»‹ dialog incoming call
- Xá»­ lÃ½ accept/reject call

#### 2.2.6. VoiceCallManager
- Voice Server (Port 9000+)
- Streaming audio real-time qua socket
- Sá»­ dá»¥ng Java Sound API (TargetDataLine/SourceDataLine)
- Format: 16kHz, 16-bit, mono

#### 2.2.7. VideoCallManager
- Video Server (Port 9500-10499)
- Audio Server cho video call (Port 9600-10599)
- Capture webcam sá»­ dá»¥ng Sarxos Webcam API
- Streaming video: 640x480, 15 FPS, JPEG compression
- Äá»“ng bá»™ audio/video streaming (2 sockets riÃªng biá»‡t)
- Auto-format detection cho audio (little-endian â†’ big-endian â†’ unsigned)
- Cleanup hoÃ n toÃ n resources khi káº¿t thÃºc call

---

## 3. TÃNH NÄ‚NG CHI TIáº¾T

### 3.1. XÃ¡c thá»±c ngÆ°á»i dÃ¹ng
**ÄÄƒng kÃ½:**
- Username tá»‘i thiá»ƒu 3 kÃ½ tá»±
- LÆ°u thÃ´ng tin dáº¡ng `username:password` trong file
- Kiá»ƒm tra trÃ¹ng láº·p username

**ÄÄƒng nháº­p:**
- XÃ¡c thá»±c vá»›i database local
- Tá»± Ä‘á»™ng khá»Ÿi táº¡o cÃ¡c port dá»±a trÃªn hashCode cá»§a username
- Ports Ä‘á»™ng: TCP (8888+), File (8890+), Voice (9000+), Video (9500+)

### 3.2. Peer Discovery
**CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng:**
1. Khi login, app thá»±c hiá»‡n 2 bÆ°á»›c scan:
   - **BÆ°á»›c 1**: Ping scan (ICMP + TCP 445/135) Ä‘á»ƒ tÃ¬m active hosts (timeout 8s)
   - **BÆ°á»›c 2**: Scan discovery ports (11000-11049) trÃªn cÃ¡c active hosts (timeout 60s)
2. Æ¯u tiÃªn scan localhost trÆ°á»›c (cÃ¹ng mÃ¡y)
3. Gá»­i message `ANNOUNCE` Ä‘áº¿n discovery port cá»§a má»—i IP
4. Peer nháº­n Ä‘Æ°á»£c sáº½ response vá»›i thÃ´ng tin cá»§a mÃ¬nh (`PEER:`)
5. Peer má»›i nháº­n thÃ´ng tin vá» táº¥t cáº£ peers hiá»‡n cÃ³ (`PEER_NOTIFY`)
6. LÆ°u peer info vÃ o `ConcurrentHashMap<String, PeerInfo>`
7. Tá»± Ä‘á»™ng refresh danh sÃ¡ch contacts
8. Heartbeat checker kiá»ƒm tra peer offline má»—i 10 giÃ¢y

**ThÃ´ng tin peer bao gá»“m:**
- IP address
- Chat port (8888-9887)
- File port (8890-9889)
- Voice port (9000-9999)
- Video port (9500-10499)
- Video audio port (9600-10599)
- Discovery port (11000-11049)

### 3.3. Chat 1-1
**Gá»­i tin nháº¯n:**
- Tá»± Ä‘á»™ng káº¿t ná»‘i socket vá»›i peer náº¿u chÆ°a cÃ³
- Format: `MESSAGE:sender:content`
- LÆ°u chat history vÃ o file local
- Hiá»ƒn thá»‹ real-time vá»›i message bubble style

**Nháº­n tin nháº¯n:**
- Listen trÃªn chat server port
- Parse message vÃ  hiá»ƒn thá»‹ trong UI
- LÆ°u vÃ o chat history

### 3.4. Chat NhÃ³m
**Táº¡o nhÃ³m:**
1. Creator chá»n tÃªn nhÃ³m vÃ  cÃ¡c thÃ nh viÃªn
2. LÆ°u file nhÃ³m cho táº¥t cáº£ thÃ nh viÃªn: `username_group_groupname.txt`
3. Gá»­i `GROUP_SYNC` message Ä‘áº¿n táº¥t cáº£ thÃ nh viÃªn
4. CÃ¡c thÃ nh viÃªn nháº­n Ä‘Æ°á»£c tá»± Ä‘á»™ng táº¡o nhÃ³m trong app

**Format file nhÃ³m:**
```
GroupName
Creator
member1,member2,member3
```

**Gá»­i tin nhÃ³m:**
- Format: `GROUP_MESSAGE:groupName:sender: message`
- Gá»­i Ä‘áº¿n táº¥t cáº£ thÃ nh viÃªn (trá»« báº£n thÃ¢n)
- Hiá»ƒn thá»‹ tÃªn ngÆ°á»i gá»­i trong nhÃ³m

### 3.5. Chia sáº» File
**CÆ¡ cháº¿:**
1. NgÆ°á»i gá»­i copy file vÃ o `shared_files/` vá»›i tÃªn unique (timestamp_filename)
2. Gá»­i metadata Ä‘áº¿n peer: `FILE::filename|size|senderIp|uniqueFilename`
3. NgÆ°á»i nháº­n tá»± Ä‘á»™ng download file tá»« File Server cá»§a ngÆ°á»i gá»­i
4. Request format: `REQUEST_FILE:uniqueFilename`
5. Náº¿u file Ä‘Ã£ tá»“n táº¡i, skip download

**Giá»›i háº¡n:**
- Max file size: 50MB
- Há»— trá»£ má»i loáº¡i file
- Hiá»ƒn thá»‹ icon theo extension (ğŸ–¼ï¸ áº£nh, ğŸ“„ PDF, ğŸ“ Word, etc.)
- Image preview: Hiá»ƒn thá»‹ preview áº£nh trong chat (max 350x350)
- Double-click áº£nh Ä‘á»ƒ xem full size
- Download on-demand vá»›i file chooser

### 3.6. Voice Call
**Khá»Ÿi táº¡o cuá»™c gá»i:**
1. Caller káº¿t ná»‘i Ä‘áº¿n Voice Server cá»§a callee (port 9000+)
2. Gá»­i `VOICE_CALL:caller`
3. Callee nháº­n incoming call dialog (auto-reject sau 30s)
4. Accept/Reject
5. Náº¿u video call Ä‘ang active, tá»± Ä‘á»™ng reject voice call

**Audio Streaming:**
- Capture tá»« microphone: TargetDataLine
- Playback qua speaker: SourceDataLine
- Format: 16kHz, 16-bit, mono, signed little-endian (Windows compatible)
- Buffer size: 1024 bytes
- Noise gate: RMS threshold 500 (chá»‰ gá»­i khi cÃ³ tiáº¿ng nÃ³i)
- Volume control: Tá»± Ä‘á»™ng giáº£m -20dB Ä‘á»ƒ trÃ¡nh echo
- Bidirectional streaming qua socket
- Real-time vá»›i latency tháº¥p
- Retry mechanism: Thá»­ má»Ÿ microphone tá»‘i Ä‘a 3 láº§n (trÃ¡nh conflict vá»›i video call)

### 3.7. Video Call
**Architecture:**
- **2 sockets**: Video socket + Audio socket riÃªng biá»‡t
- Video: Port 9500-10499
- Audio: Port 9600-10599
- Caller káº¿t ná»‘i video trÆ°á»›c, sau Ä‘Ã³ káº¿t ná»‘i audio
- Receiver nháº­n video call, sau Ä‘Ã³ káº¿t ná»‘i audio socket Ä‘áº¿n caller

**Video Streaming:**
1. Capture tá»« webcam (640x480) sá»­ dá»¥ng Sarxos Webcam API
2. Convert BufferedImage â†’ JPEG
3. Send qua DataOutputStream: `[size:4bytes][imageData]`
4. FPS: 15 frames/second (frame delay ~66ms)
5. Hiá»ƒn thá»‹ local video (200x150 overlay gÃ³c pháº£i trÃªn) + remote video (800x600 main)
6. End signal: Gá»­i size = -1 Ä‘á»ƒ bÃ¡o hiá»‡u káº¿t thÃºc

**Audio Streaming:**
- Auto-format detection: Thá»­ little-endian â†’ big-endian â†’ unsigned
- TÆ°Æ¡ng tá»± voice call nhÆ°ng cháº¡y song song vá»›i video
- Volume control: Tá»± Ä‘á»™ng giáº£m -20dB
- Äá»“ng bá»™ hÃ³a timing vá»›i video
- Cleanup hoÃ n toÃ n: ÄÃ³ng microphone, speaker, webcam, sockets

**UI Features:**
- Local video: 200x150 (overlay gÃ³c pháº£i trÃªn)
- Remote video: 800x600 (main screen)
- Controls: Mute (ğŸ¤), Camera toggle (ğŸ“·), End call (ğŸ”´)
- Status indicators: "Äang káº¿t ná»‘i..." â†’ "âœ… ÄÃ£ káº¿t ná»‘i"
- Dark theme (#1C1C1E background)

**Typing Indicators:**
- Gá»­i `TYPING` khi báº¯t Ä‘áº§u gÃµ (1-1 chat)
- Gá»­i `STOP_TYPING` khi dá»«ng gÃµ hoáº·c gá»­i tin nháº¯n
- Group typing: `GROUP_TYPING:groupName:username`
- Auto-hide sau 5 giÃ¢y náº¿u khÃ´ng nháº­n stop signal
- Hiá»ƒn thá»‹: "username Ä‘ang gÃµ..." hoáº·c "X ngÆ°á»i Ä‘ang gÃµ..."

---

## 4. GIAO THá»¨C TRUYá»€N THÃ”NG VÃ€ Sá»¬ Dá»¤NG TCP/UDP

### 4.1. Tá»•ng quan vá» TCP vÃ  UDP trong á»©ng dá»¥ng

á»¨ng dá»¥ng Chat P2P sá»­ dá»¥ng **TCP (Transmission Control Protocol)** lÃ m giao thá»©c chÃ­nh cho táº¥t cáº£ cÃ¡c dá»‹ch vá»¥ máº¡ng. **á»¨ng dá»¥ng KHÃ”NG sá»­ dá»¥ng UDP** trong implementation hiá»‡n táº¡i. Táº¥t cáº£ cÃ¡c káº¿t ná»‘i máº¡ng Ä‘á»u sá»­ dá»¥ng `java.net.Socket` vÃ  `java.net.ServerSocket` (TCP), khÃ´ng cÃ³ `java.net.DatagramSocket` (UDP) nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng.

Quyáº¿t Ä‘á»‹nh nÃ y dá»±a trÃªn cÃ¡c yÃªu cáº§u vá» Ä‘á»™ tin cáº­y, thá»© tá»± dá»¯ liá»‡u vÃ  kiá»ƒm soÃ¡t luá»“ng cá»§a á»©ng dá»¥ng.

#### 4.1.1. Táº¡i sao chá»n TCP thay vÃ¬ UDP?

**Æ¯u Ä‘iá»ƒm cá»§a TCP phÃ¹ há»£p vá»›i á»©ng dá»¥ng:**
- âœ… **Äáº£m báº£o Ä‘á»™ tin cáº­y**: Táº¥t cáº£ dá»¯ liá»‡u Ä‘Æ°á»£c Ä‘áº£m báº£o gá»­i Ä‘áº¿n Ä‘Ã­ch (ACK mechanism)
- âœ… **Äáº£m báº£o thá»© tá»±**: Dá»¯ liá»‡u luÃ´n Ä‘Æ°á»£c nháº­n Ä‘Ãºng thá»© tá»± gá»­i (sequence numbers)
- âœ… **Kiá»ƒm soÃ¡t luá»“ng**: TrÃ¡nh overflow buffer á»Ÿ receiver (flow control)
- âœ… **Kiá»ƒm soÃ¡t táº¯c ngháº½n**: Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh tá»‘c Ä‘á»™ gá»­i (congestion control)
- âœ… **Káº¿t ná»‘i cÃ³ tráº¡ng thÃ¡i**: Dá»… quáº£n lÃ½ session vÃ  cleanup resources

**NhÆ°á»£c Ä‘iá»ƒm cá»§a UDP khÃ´ng phÃ¹ há»£p:**
- âŒ **KhÃ´ng Ä‘áº£m báº£o delivery**: CÃ³ thá»ƒ máº¥t gÃ³i tin (khÃ´ng phÃ¹ há»£p cho chat, file transfer)
- âŒ **KhÃ´ng Ä‘áº£m báº£o thá»© tá»±**: GÃ³i tin cÃ³ thá»ƒ Ä‘áº¿n sai thá»© tá»± (áº£nh hÆ°á»Ÿng Ä‘áº¿n video/audio)
- âŒ **KhÃ´ng cÃ³ flow control**: Dá»… gÃ¢y overflow á»Ÿ receiver
- âŒ **Connectionless**: KhÃ³ quáº£n lÃ½ state vÃ  cleanup

#### 4.1.2. Kiáº¿n trÃºc TCP trong á»©ng dá»¥ng

á»¨ng dá»¥ng sá»­ dá»¥ng mÃ´ hÃ¬nh **Client-Server** vá»›i TCP, má»—i peer Ä‘Ã³ng vai trÃ² vá»«a lÃ  client vá»«a lÃ  server:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PEER A (Alice)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ TCP Server   â”‚         â”‚ TCP Client   â”‚              â”‚
â”‚  â”‚ (Listen)     â”‚         â”‚ (Connect)    â”‚              â”‚
â”‚  â”‚              â”‚         â”‚              â”‚              â”‚
â”‚  â”‚ Port 8888    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Port 8888    â”‚              â”‚
â”‚  â”‚ (Chat)       â”‚  TCP    â”‚ (Chat)       â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ Port 8890    â”‚         â”‚ Port 8890    â”‚              â”‚
â”‚  â”‚ (File)       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ (File)       â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â–²                           â–²
         â”‚                           â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ TCP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PEER B (Bob)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ TCP Server   â”‚         â”‚ TCP Client   â”‚              â”‚
â”‚  â”‚ (Listen)     â”‚         â”‚ (Connect)    â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2. Sá»­ dá»¥ng TCP cho cÃ¡c dá»‹ch vá»¥

#### 4.2.1. TCP cho Peer Discovery (Port 11000-11049)

**CÆ¡ cháº¿ hoáº¡t Ä‘á»™ng:**
1. **Server Socket**: Má»—i peer táº¡o `ServerSocket` trÃªn discovery port Ä‘á»ƒ láº¯ng nghe
2. **Client Socket**: Peer má»›i táº¡o `Socket` Ä‘á»ƒ káº¿t ná»‘i Ä‘áº¿n discovery port cá»§a peer khÃ¡c
3. **Three-way handshake**: TCP tá»± Ä‘á»™ng thá»±c hiá»‡n SYN â†’ SYN-ACK â†’ ACK
4. **Gá»­i ANNOUNCE**: Sau khi káº¿t ná»‘i thÃ nh cÃ´ng, gá»­i thÃ´ng tin peer
5. **Nháº­n PEER response**: Nháº­n thÃ´ng tin peer vÃ  Ä‘Ã³ng káº¿t ná»‘i

**Táº¡i sao dÃ¹ng TCP cho Discovery:**
- Äáº£m báº£o thÃ´ng tin discovery Ä‘Æ°á»£c gá»­i Ä‘áº¿n Ä‘Ãºng Ä‘Ã­ch
- CÃ³ thá»ƒ phÃ¡t hiá»‡n peer offline ngay khi káº¿t ná»‘i tháº¥t báº¡i
- Dá»… xá»­ lÃ½ timeout vÃ  retry

**Flow:**
```
Peer A (New)                    Peer B (Existing)
    |                                |
    |-------- TCP Connect ---------->|
    |         (SYN)                  |
    |<-------- SYN-ACK --------------|
    |-------- ACK ------------------>|
    |                                |
    |-------- ANNOUNCE:alice ------->|
    |         (PrintWriter)          |
    |<-------- PEER:bob:ports... ----|
    |         (BufferedReader)       |
    |-------- Close Socket --------->|
    |                                |
```

#### 4.2.2. TCP cho Chat Messages (Port 8888-9887)

**Kiáº¿n trÃºc persistent connection:**
- Má»—i peer pair duy trÃ¬ má»™t TCP connection lÃ¢u dÃ i
- Connection Ä‘Æ°á»£c tÃ¡i sá»­ dá»¥ng cho nhiá»u messages
- Chá»‰ táº¡o connection má»›i khi chÆ°a cÃ³ hoáº·c connection bá»‹ Ä‘Ã³ng

**Æ¯u Ä‘iá»ƒm:**
- Giáº£m overhead cá»§a TCP handshake (chá»‰ 1 láº§n)
- Giáº£m latency cho messages tiáº¿p theo
- Dá»… quáº£n lÃ½ state (typing indicators, online status)

**Message flow:**
```
Alice                          Bob
  |                             |
  |-------- TCP Connect ------->|
  |         (SYN-SYN-ACK-ACK)   |
  |                             |
  |-------- HELLO:alice ------->|
  |<-------- HELLO:bob ---------|
  |                             |
  |-------- MESSAGE:alice:Hi -->|
  |         (guaranteed delivery)|
  |<-------- MESSAGE:bob:Hello -|
  |                             |
  |-------- MESSAGE:alice:... -->|
  |         (reuse connection)   |
  |<-------- MESSAGE:bob:... ----|
  |                             |
  |-------- [Connection stays]   |
  |         [open for more msgs] |
```

**Xá»­ lÃ½ lá»—i:**
- Náº¿u connection bá»‹ Ä‘Ã³ng â†’ tá»± Ä‘á»™ng reconnect khi gá»­i message tiáº¿p theo
- Heartbeat checker phÃ¡t hiá»‡n connection dead â†’ remove khá»i danh sÃ¡ch

#### 4.2.3. TCP cho File Transfer (Port 8890-9889)

**Táº¡i sao TCP cho file transfer:**
- **Äáº£m báº£o tÃ­nh toÃ n váº¹n**: File pháº£i Ä‘Æ°á»£c nháº­n Ä‘áº§y Ä‘á»§, khÃ´ng máº¥t byte nÃ o
- **Thá»© tá»± dá»¯ liá»‡u**: CÃ¡c chunk file pháº£i Ä‘Æ°á»£c nháº­n Ä‘Ãºng thá»© tá»±
- **Kiá»ƒm soÃ¡t luá»“ng**: TrÃ¡nh receiver bá»‹ quÃ¡ táº£i khi nháº­n file lá»›n

**CÆ¡ cháº¿ transfer:**
1. **Metadata qua Chat TCP**: Gá»­i thÃ´ng tin file (tÃªn, size) qua chat connection
2. **File data qua File TCP**: Táº¡o connection riÃªng Ä‘á»ƒ transfer file
3. **Streaming**: Äá»c file theo chunk (8KB buffer) vÃ  gá»­i qua TCP
4. **Verification**: Receiver Ä‘á»c Ä‘Ãºng sá»‘ bytes nhÆ° metadata

**Flow:**
```
Sender                         Receiver
  |                               |
  |-- FILE:name|size|ip|id ------>| (via Chat TCP)
  |                               |
  |<-- REQUEST_FILE:id -----------| (via File TCP)
  |                               |
  |-- [File data chunks] -------->|
  |   (8KB per chunk)             |
  |   (TCP ensures order)         |
  |                               |
  |-- [More chunks] ------------->|
  |                               |
  |-- [EOF] --------------------->|
  |                               |
```

**Lá»£i Ã­ch TCP:**
- Tá»± Ä‘á»™ng retransmit náº¿u packet bá»‹ máº¥t
- Äáº£m báº£o file Ä‘Æ°á»£c nháº­n Ä‘áº§y Ä‘á»§
- Flow control trÃ¡nh buffer overflow

#### 4.2.4. TCP cho Voice Call (Port 9000-9999)

**Äáº·c Ä‘iá»ƒm:**
- **Bidirectional streaming**: Cáº£ 2 bÃªn gá»­i/nháº­n audio Ä‘á»“ng thá»i
- **Real-time requirement**: Cáº§n latency tháº¥p (< 200ms)
- **Continuous connection**: Connection má»Ÿ suá»‘t cuá»™c gá»i

**Audio streaming qua TCP:**
- Capture audio tá»« microphone (1024 bytes buffer)
- Gá»­i qua TCP socket (Ä‘áº£m báº£o delivery)
- Nháº­n audio tá»« peer vÃ  play qua speaker

**Trade-off TCP vs UDP cho Voice:**
- **TCP (Ä‘ang dÃ¹ng)**: Äáº£m báº£o delivery nhÆ°ng cÃ³ thá»ƒ delay náº¿u retransmit
- **UDP (khÃ´ng dÃ¹ng)**: Latency tháº¥p hÆ¡n nhÆ°ng cÃ³ thá»ƒ máº¥t packet (audio bá»‹ giÃ¡n Ä‘oáº¡n)

**Quyáº¿t Ä‘á»‹nh dÃ¹ng TCP (khÃ´ng dÃ¹ng UDP):**
- Trong mÃ´i trÆ°á»ng LAN, TCP retransmit nhanh (< 50ms)
- Äáº£m báº£o cháº¥t lÆ°á»£ng audio tá»‘t hÆ¡n (khÃ´ng máº¥t packet)
- Dá»… implement vÃ  debug (khÃ´ng cáº§n xá»­ lÃ½ packet loss)
- Code Ä‘Æ¡n giáº£n hÆ¡n (chá»‰ cáº§n Socket, khÃ´ng cáº§n DatagramSocket)

#### 4.2.5. TCP cho Video Call (Port 9500-10499, 9600-10599)

**Kiáº¿n trÃºc dual-socket:**
- **Video socket**: Gá»­i/nháº­n video frames (JPEG compressed)
- **Audio socket**: Gá»­i/nháº­n audio riÃªng biá»‡t

**Video streaming qua TCP:**
- Capture frame tá»« webcam (640x480, 15 FPS)
- Compress thÃ nh JPEG (~10-50KB per frame)
- Gá»­i qua TCP: `[4 bytes size][JPEG data]`
- Receiver nháº­n vÃ  hiá»ƒn thá»‹

**Táº¡i sao TCP cho Video:**
- **Frame integrity**: Má»—i frame pháº£i Ä‘Æ°á»£c nháº­n Ä‘áº§y Ä‘á»§
- **Order guarantee**: Frames pháº£i hiá»ƒn thá»‹ Ä‘Ãºng thá»© tá»±
- **Error recovery**: Tá»± Ä‘á»™ng retransmit náº¿u frame bá»‹ corrupt

**Audio trong Video Call:**
- TÆ°Æ¡ng tá»± voice call nhÆ°ng cháº¡y song song vá»›i video
- Sync timing giá»¯a audio vÃ  video
- TCP Ä‘áº£m báº£o audio khÃ´ng bá»‹ máº¥t (quan trá»ng cho lip-sync)

### 4.3. TCP Connection Management

#### 4.3.1. Connection Lifecycle

**1. Connection Establishment (Three-way Handshake)**
```
Client                          Server
  |                               |
  |-------- SYN (seq=x) ---------->|
  |                                |
  |<------- SYN-ACK (seq=y, ack=x+1)|
  |                                |
  |-------- ACK (ack=y+1) -------->|
  |                                |
  |      [Connection Established]  |
```

**2. Data Transfer**
- Sá»­ dá»¥ng `BufferedReader` vÃ  `PrintWriter` vá»›i UTF-8 encoding
- Má»—i message káº¿t thÃºc báº±ng newline (`\n`)
- TCP tá»± Ä‘á»™ng Ä‘áº£m báº£o delivery vÃ  order

**3. Connection Termination**
```
Peer A                          Peer B
  |                               |
  |-------- FIN ------------------>|
  |<------- ACK -------------------|
  |                                |
  |<------- FIN -------------------|
  |-------- ACK ------------------>|
  |                                |
  |      [Connection Closed]       |
```

#### 4.3.2. Connection Pooling vÃ  Reuse

**Chiáº¿n lÆ°á»£c:**
- Má»—i peer pair duy trÃ¬ 1 TCP connection cho chat
- Connection Ä‘Æ°á»£c reuse cho nhiá»u messages
- Tá»± Ä‘á»™ng reconnect náº¿u connection bá»‹ Ä‘Ã³ng

**Lá»£i Ã­ch:**
- Giáº£m overhead cá»§a TCP handshake
- Giáº£m latency
- Tiáº¿t kiá»‡m tÃ i nguyÃªn há»‡ thá»‘ng

#### 4.3.3. Error Handling vÃ  Recovery

**CÃ¡c tÃ¬nh huá»‘ng lá»—i:**
1. **Connection timeout**: Socket timeout (5-30s tÃ¹y service)
2. **Connection refused**: Peer offline hoáº·c firewall block
3. **Connection reset**: Peer Ä‘Ã³ng connection Ä‘á»™t ngá»™t
4. **Network unreachable**: Máº¥t káº¿t ná»‘i máº¡ng

**CÆ¡ cháº¿ recovery:**
- Retry connection khi gá»­i message tiáº¿p theo
- Heartbeat checker phÃ¡t hiá»‡n dead connection
- Remove peer khá»i danh sÃ¡ch náº¿u khÃ´ng thá»ƒ reconnect

### 4.4. So sÃ¡nh TCP vÃ  UDP cho tá»«ng dá»‹ch vá»¥

| Dá»‹ch vá»¥ | Giao thá»©c | LÃ½ do | Trade-off |
|---------|-----------|-------|-----------|
| **Discovery** | TCP | Äáº£m báº£o thÃ´ng tin Ä‘Æ°á»£c nháº­n | Overhead handshake nhÆ°ng chá»‰ 1 láº§n |
| **Chat Messages** | TCP | Äáº£m báº£o message Ä‘Æ°á»£c gá»­i Ä‘áº¿n | Latency cao hÆ¡n UDP nhÆ°ng Ä‘Ã¡ng tin cáº­y |
| **File Transfer** | TCP | File pháº£i Ä‘áº§y Ä‘á»§, Ä‘Ãºng thá»© tá»± | Cháº­m hÆ¡n UDP nhÆ°ng Ä‘áº£m báº£o integrity |
| **Voice Call** | TCP | Äáº£m báº£o audio khÃ´ng bá»‹ máº¥t | CÃ³ thá»ƒ delay náº¿u retransmit nhÆ°ng cháº¥t lÆ°á»£ng tá»‘t |
| **Video Call** | TCP | Frame pháº£i Ä‘áº§y Ä‘á»§, Ä‘Ãºng thá»© tá»± | CÃ³ thá»ƒ jitter nhÆ°ng khÃ´ng bá»‹ corrupt |

### 4.5. Tá»‘i Æ°u hÃ³a TCP Performance

#### 4.5.1. Socket Options

**CÃ¡c tÃ¹y chá»n Ä‘Æ°á»£c sá»­ dá»¥ng:**
- `SO_TIMEOUT`: Äáº·t timeout Ä‘á»ƒ trÃ¡nh blocking vÃ´ háº¡n
- `SO_REUSEADDR`: Cho phÃ©p reuse address (cho session lock)
- `TCP_NODELAY`: CÃ³ thá»ƒ báº­t Ä‘á»ƒ giáº£m latency (chÆ°a implement)

#### 4.5.2. Buffer Sizes

**Tá»‘i Æ°u buffer:**
- Chat: Default buffer (Ä‘á»§ cho text messages)
- File: 8KB buffer (cÃ¢n báº±ng giá»¯a memory vÃ  performance)
- Audio: 1024 bytes (phÃ¹ há»£p vá»›i audio format)
- Video: Dynamic (theo size cá»§a JPEG frame)

#### 4.5.3. Connection Pooling

**Quáº£n lÃ½ connections:**
- Sá»­ dá»¥ng `ConcurrentHashMap` Ä‘á»ƒ lÆ°u active connections
- Reuse connection thay vÃ¬ táº¡o má»›i má»—i láº§n
- Cleanup connections khi peer offline

### 4.6. Háº¡n cháº¿ cá»§a TCP vÃ  giáº£i phÃ¡p

#### 4.6.1. Head-of-line Blocking

**Váº¥n Ä‘á»:**
- Náº¿u má»™t packet bá»‹ máº¥t, cÃ¡c packet sau pháº£i Ä‘á»£i retransmit
- áº¢nh hÆ°á»Ÿng Ä‘áº¿n real-time streaming (voice/video)

**Giáº£i phÃ¡p hiá»‡n táº¡i:**
- Sá»­ dá»¥ng separate sockets cho video vÃ  audio
- Buffer nhá» Ä‘á»ƒ giáº£m delay
- Trong LAN, packet loss ráº¥t tháº¥p nÃªn Ã­t áº£nh hÆ°á»Ÿng

#### 4.6.2. TCP Overhead

**Váº¥n Ä‘á»:**
- TCP header 20 bytes (so vá»›i UDP 8 bytes)
- ACK packets tÄƒng traffic

**Giáº£i phÃ¡p:**
- Reuse connections Ä‘á»ƒ giáº£m handshake overhead
- Batch messages khi cÃ³ thá»ƒ (chÆ°a implement)

#### 4.6.3. Latency trong Real-time

**Váº¥n Ä‘á»:**
- TCP retransmit cÃ³ thá»ƒ gÃ¢y delay
- KhÃ´ng phÃ¹ há»£p cho real-time cá»±c ká»³ nháº¡y cáº£m

**Giáº£i phÃ¡p tÆ°Æ¡ng lai:**
- CÃ³ thá»ƒ hybrid: TCP cho control, UDP cho streaming
- Sá»­ dá»¥ng WebRTC (UDP-based) cho voice/video

### 4.7. Káº¿t luáº­n vá» TCP/UDP

**Quyáº¿t Ä‘á»‹nh thiáº¿t káº¿:**
- á»¨ng dá»¥ng sá»­ dá»¥ng **100% TCP** cho táº¥t cáº£ dá»‹ch vá»¥
- **KHÃ”NG sá»­ dá»¥ng UDP** trong code hiá»‡n táº¡i
- Táº¥t cáº£ káº¿t ná»‘i Ä‘á»u sá»­ dá»¥ng `Socket` vÃ  `ServerSocket` (TCP)
- KhÃ´ng cÃ³ `DatagramSocket` hay `DatagramPacket` (UDP) nÃ o Ä‘Æ°á»£c sá»­ dá»¥ng

**LÃ½ do chá»n TCP hoÃ n toÃ n:**
- Äá»™ tin cáº­y quan trá»ng hÆ¡n latency trong mÃ´i trÆ°á»ng LAN
- Trong LAN, TCP overhead vÃ  latency cháº¥p nháº­n Ä‘Æ°á»£c (< 50ms)
- ÄÆ¡n giáº£n trong implementation (chá»‰ cáº§n há»c 1 giao thá»©c)
- Dá»… debug vÃ  maintain (TCP cÃ³ error handling tá»‘t)

**Æ¯u Ä‘iá»ƒm cá»§a viá»‡c chá»‰ dÃ¹ng TCP:**
- âœ… ÄÆ¡n giáº£n trong implementation
- âœ… Äáº£m báº£o data integrity (khÃ´ng máº¥t packet)
- âœ… Dá»… debug vÃ  maintain
- âœ… KhÃ´ng cáº§n xá»­ lÃ½ packet loss, reordering
- âœ… Tá»± Ä‘á»™ng retransmit khi cÃ³ lá»—i

**NhÆ°á»£c Ä‘iá»ƒm (so vá»›i hybrid TCP/UDP):**
- âŒ Latency cao hÆ¡n UDP cho real-time streaming
- âŒ Overhead lá»›n hÆ¡n (TCP header + ACK)
- âŒ Head-of-line blocking (áº£nh hÆ°á»Ÿng video/audio)
- âŒ KhÃ´ng tá»‘i Æ°u cho voice/video streaming

**Táº¡i sao khÃ´ng dÃ¹ng UDP:**
- Trong mÃ´i trÆ°á»ng LAN, packet loss ráº¥t tháº¥p (< 0.1%)
- TCP retransmit nhanh (< 50ms trong LAN)
- Cháº¥t lÆ°á»£ng audio/video váº«n tá»‘t vá»›i TCP
- KhÃ´ng cáº§n Ä‘á»™ phá»©c táº¡p cá»§a UDP + error handling

**HÆ°á»›ng phÃ¡t triá»ƒn tÆ°Æ¡ng lai:**
- CÃ³ thá»ƒ hybrid TCP/UDP trong tÆ°Æ¡ng lai
- **UDP cho real-time streaming**: Voice/video call vá»›i RTP/RTCP
- **TCP cho control messages**: Discovery, chat, file transfer
- Sá»­ dá»¥ng WebRTC framework (UDP-based) cho voice/video
- Implement FEC (Forward Error Correction) cho UDP streaming

---

## 4.8. Message Protocol
```
MESSAGE_TYPE:PARAM1:PARAM2:...

VÃ­ dá»¥:
- MESSAGE:john:Hello World
- FILE::document.pdf|1024|192.168.1.5|1234567_document.pdf
- GROUP_MESSAGE:Team:alice: Meeting at 3pm
- GROUP_SYNC:ProjectTeam:bob:bob,alice,charlie
- VOICE_CALL:john
- VIDEO_CALL:alice
- CALL_ACCEPTED:bob
- CALL_REJECTED:charlie
```

### 4.9. Connection Flow
**Peer Connection:**
```
Client                          Server
  |                               |
  |-------- HELLO:username ------>|
  |                               |
  |<------- HELLO:username -------|
  |                               |
  |<----- Messages exchange ----->|
```

**Discovery:**
```
New Peer                    Existing Peer
  |                               |
  |-- ANNOUNCE:user:ports... ---->|
  |                               |
  |<-- PEER:user:ports... --------|
```

---

## 5. QUáº¢N LÃ Dá»® LIá»†U

### 5.1. Cáº¥u trÃºc thÆ° má»¥c
```
project/
â”œâ”€â”€ users.txt                 # TÃ i khoáº£n
â”œâ”€â”€ chat_history/             # Lá»‹ch sá»­ chat
â”‚   â”œâ”€â”€ alice_bob.txt
â”‚   â””â”€â”€ alice_Team_group.txt
â”œâ”€â”€ groups/                   # ThÃ´ng tin nhÃ³m
â”‚   â”œâ”€â”€ alice_group_Team.txt
â”‚   â””â”€â”€ bob_group_Team.txt
â””â”€â”€ shared_files/             # Files Ä‘Æ°á»£c chia sáº»
    â””â”€â”€ 1234567_document.pdf
```

### 5.2. Chat History Format
```
[2025-11-02 14:30:25] alice: Hello
[2025-11-02 14:30:30] bob: Hi there
[2025-11-02 14:31:00] alice: [FILE:report.pdf]
[2025-11-02 14:32:00] System: âœ… charlie Ä‘Ã£ tham gia nhÃ³m
```

**LÆ°u Ã½**: 
- Format: `[YYYY-MM-DD HH:mm:ss] sender: message`
- Group chat: `[timestamp] sender: message` (sender lÃ  username)
- System messages: ThÃ´ng bÃ¡o thÃ nh viÃªn tham gia/rá»i nhÃ³m

---

## 6. Xá»¬ LÃ Äá»’NG Bá»˜ VÃ€ CONCURRENCY

### 6.1. Thread Management
- **Discovery threads**: 
    - Ping scan: 254 threads song song (ExecutorService 50 threads)
    - Discovery scan: 50 ports Ã— sá»‘ active hosts
    - Timeout: Ping 8s, Discovery scan 60s
- **Server threads**: Accept connections (Discovery, Chat, File, Voice, Video)
- **Connection threads**: Má»—i peer connection 1 thread (Ä‘á»c message liÃªn tá»¥c)
- **Call threads**: 
    - Voice: Audio send/receive (2 threads)
    - Video: Video send/receive/display (3 threads) + Audio send/receive (2 threads)
- **Session lock**: 1 thread cho local lock server
- **Heartbeat checker**: 1 thread kiá»ƒm tra peer offline (10s interval)
- **Daemon threads**: Video/audio threads set daemon = true

### 6.2. Concurrent Data Structures
```java
ConcurrentHashMap<String, PeerConnection> peerConnections
ConcurrentHashMap<String, PeerInfo> discoveredPeers
ConcurrentHashMap<String, ChatGroup> chatGroups
```

### 6.3. Synchronization
- Platform.runLater() cho UI updates tá»« background threads
- AtomicBoolean cho call state management (isCallActive, isVideoCallActive)
- Socket timeouts Ä‘á»ƒ trÃ¡nh blocking vÃ´ háº¡n (5s-30s tÃ¹y service)
- ConcurrentHashMap cho thread-safe collections
- ExecutorService cho quáº£n lÃ½ thread pool
- CountDownLatch cho Ä‘á»“ng bá»™ ping scan

---

## 7. GIAO DIá»†N NGÆ¯á»œI DÃ™NG

### 7.1. Login Screen
- Gradient background (#0068FF â†’ #0091FF)
- Form tráº¯ng bo trÃ²n vá»›i shadow
- Validation real-time
- Error/success messages

### 7.2. Main Chat Screen
**Layout:**
- **Left Sidebar (320px)**: User header + Search + Contacts list
- **Center Panel**: Chat header + Messages + Input box
- **Message Bubbles**:
  - Sent: Blue (#007AFF), right-aligned
  - Received: Gray (#E5E5EA), left-aligned
  - Max width 300px, wrap text

### 7.3. Call Dialogs
**Incoming Call:**
- Modal dialog
- Caller info
- Accept/Reject buttons
- Auto-reject sau 30s

**Active Call:**
- Voice: Icon + Timer + End button
- Video: Local/remote video + Controls

---

## 8. Xá»¬ LÃ Lá»–I VÃ€ EDGE CASES

### 8.1. Network Errors
- Connection timeout: 5s cho file transfer, 30s cho video call
- Socket closed: Tá»± Ä‘á»™ng cleanup vÃ  remove tá»« connections map
- Peer offline: Retry connection khi gá»­i message

### 8.2. File Transfer
- File exists: Skip download, use local copy
- File not found: Response ERROR message
- Large files: Limit 50MB

### 8.3. Call Errors
- Webcam khÃ´ng kháº£ dá»¥ng: Reject call vÃ  thÃ´ng bÃ¡o
- Audio device busy: Retry mechanism (3 láº§n cho voice, auto-format detection cho video)
- Connection lost: Auto cleanup threads vÃ  resources (gá»­i END signal trÆ°á»›c)
- Video call conflict: Tá»± Ä‘á»™ng reject voice call náº¿u video call Ä‘ang active
- Socket timeout: 30s cho video call, 5s cho file transfer
- Cleanup hoÃ n toÃ n: ÄÃ³ng microphone, speaker, webcam, sockets, set null references

### 8.4. Group Sync
- Duplicate group: Update members list
- Member offline: Skip, sync khi online láº¡i
- File save error: Log vÃ  continue

---

## 9. ÄÃNH GIÃ VÃ€ Háº N CHáº¾

### 9.1. Æ¯u Ä‘iá»ƒm
âœ… **KhÃ´ng cáº§n server**: HoÃ n toÃ n P2P, giáº£m chi phÃ­ infrastructure
âœ… **Real-time**: Event-driven architecture, latency tháº¥p
âœ… **Tá»± Ä‘á»™ng discovery**: Scan thÃ´ng minh (ping + TCP) Ä‘á»ƒ tÃ¬m active hosts nhanh
âœ… **Äa tÃ­nh nÄƒng**: Text, file, voice, video, group chat, typing indicators
âœ… **Modern UI**: JavaFX vá»›i design hiá»‡n Ä‘áº¡i, image preview, online indicators
âœ… **Thread-safe**: Sá»­ dá»¥ng concurrent collections, AtomicBoolean
âœ… **Session management**: NgÄƒn Ä‘Äƒng nháº­p trÃ¹ng láº·p trÃªn LAN
âœ… **Noise gate**: Lá»c tiáº¿ng á»“n trong voice call
âœ… **Smart cleanup**: Äáº£m báº£o resources Ä‘Æ°á»£c giáº£i phÃ³ng hoÃ n toÃ n

### 9.2. Háº¡n cháº¿
âŒ **LAN only**: Chá»‰ hoáº¡t Ä‘á»™ng trong cÃ¹ng subnet (khÃ´ng há»— trá»£ Internet)
âŒ **No encryption**: Data truyá»n plain text (chÆ°a mÃ£ hÃ³a)
âŒ **No authentication**: Password lÆ°u plain text trong users.txt
âŒ **File size limit**: Max 50MB
âŒ **Video quality**: Cá»‘ Ä‘á»‹nh 15 FPS, 640x480, khÃ´ng adaptive bitrate
âŒ **No NAT traversal**: KhÃ´ng hoáº¡t Ä‘á»™ng qua router/firewall phá»©c táº¡p
âŒ **Single device per user**: Má»—i username chá»‰ Ä‘Äƒng nháº­p trÃªn 1 mÃ¡y (session lock)
âŒ **Discovery scan time**: CÃ³ thá»ƒ máº¥t 8-60 giÃ¢y Ä‘á»ƒ scan toÃ n bá»™ LAN
âŒ **Echo trong call**: Váº«n cÃ³ thá»ƒ echo náº¿u khÃ´ng dÃ¹ng headphone

### 9.3. Váº¥n Ä‘á» Ä‘Ã£ sá»­a
âœ… **Group sync issue**: ÄÃ£ thÃªm xá»­ lÃ½ `GROUP_SYNC` message vá»›i thÃ´ng bÃ¡o thÃ nh viÃªn má»›i/rá»i
âœ… **Video call connection**: ÄÃ£ Ä‘á»“ng bá»™ video/audio sockets (caller káº¿t ná»‘i audio sau khi accept)
âœ… **Thread cleanup**: Proper shutdown cá»§a resources (microphone, speaker, webcam, sockets)
âœ… **Audio device conflict**: Retry mechanism vÃ  auto-format detection
âœ… **Discovery performance**: Tá»‘i Æ°u tá»« 1000 ports xuá»‘ng 50 ports, ping scan trÆ°á»›c
âœ… **Session lock**: NgÄƒn Ä‘Äƒng nháº­p trÃ¹ng láº·p trÃªn LAN
âœ… **Typing indicators**: Implement cho cáº£ 1-1 vÃ  group chat
âœ… **Image preview**: Hiá»ƒn thá»‹ preview áº£nh trong chat

---

## 10. HÆ¯á»šNG PHÃT TRIá»‚N

### 10.1. TÃ­nh nÄƒng má»›i
- ğŸ” **End-to-end encryption**: RSA + AES
- ğŸŒ **NAT traversal**: STUN/TURN servers Ä‘á»ƒ hoáº¡t Ä‘á»™ng qua Internet
- ğŸ“± **Mobile app**: Android/iOS client
- ğŸ’¾ **Cloud backup**: Optional sync chat history lÃªn cloud
- ğŸ¨ **Themes**: Dark mode, custom themes
- ğŸ”” **Notifications**: System tray notifications
- ğŸ“ **Call history**: LÆ°u lá»‹ch sá»­ cuá»™c gá»i
- ğŸ‘¥ **Group video call**: Conference vá»›i nhiá»u ngÆ°á»i

### 10.2. Cáº£i tiáº¿n ká»¹ thuáº­t
- **WebRTC**: Thay socket báº±ng WebRTC cho voice/video
- **Database**: SQLite thay vÃ¬ text files
- **Compression**: Compress messages vÃ  files
- **Adaptive bitrate**: Auto-adjust video quality theo bandwidth
- **Reconnection**: Auto-reconnect khi connection lost
- **Testing**: Unit tests, integration tests
- **Logging**: Log4j cho production debugging

### 10.3. UI/UX
- Emoji picker
- Message reactions
- Reply/forward messages
- Message search
- User profiles with avatars
- Typing indicators
- Read receipts
- Drag & drop file upload

---

## 11. Káº¾T LUáº¬N

á»¨ng dá»¥ng Chat P2P Ä‘Ã£ thÃ nh cÃ´ng xÃ¢y dá»±ng má»™t há»‡ thá»‘ng giao tiáº¿p ngang hÃ ng hoÃ n chá»‰nh vá»›i Ä‘áº§y Ä‘á»§ cÃ¡c tÃ­nh nÄƒng cÆ¡ báº£n vÃ  nÃ¢ng cao. Kiáº¿n trÃºc event-driven káº¿t há»£p vá»›i multi-threading Ä‘áº£m báº£o hiá»‡u nÄƒng real-time tá»‘t. Giao diá»‡n JavaFX hiá»‡n Ä‘áº¡i mang láº¡i tráº£i nghiá»‡m ngÆ°á»i dÃ¹ng tÆ°Æ¡ng tá»± cÃ¡c á»©ng dá»¥ng chat phá»• biáº¿n.

Dá»± Ã¡n Ä‘Ã£ chá»©ng minh kháº£ nÄƒng triá»ƒn khai P2P communication mÃ  khÃ´ng cáº§n infrastructure phá»©c táº¡p, phÃ¹ há»£p cho mÃ´i trÆ°á»ng LAN nhÆ° vÄƒn phÃ²ng, trÆ°á»ng há»c. Vá»›i nhá»¯ng cáº£i tiáº¿n Ä‘á» xuáº¥t vá» báº£o máº­t vÃ  kháº£ nÄƒng má»Ÿ rá»™ng, á»©ng dá»¥ng cÃ³ tiá»m nÄƒng phÃ¡t triá»ƒn thÃ nh má»™t giáº£i phÃ¡p chat Ä‘áº§y Ä‘á»§ cho doanh nghiá»‡p.

---

## PHU Lá»¤C

### A. Dependencies
```xml
<!-- pom.xml -->
<dependencies>
    <dependency>
        <groupId>org.openjfx</groupId>
        <artifactId>javafx-controls</artifactId>
        <version>17.0.2</version>
    </dependency>
    <dependency>
        <groupId>com.github.sarxos</groupId>
        <artifactId>webcam-capture</artifactId>
        <version>0.3.12</version>
    </dependency>
</dependencies>
```

### B. System Requirements
- Java 8 hoáº·c cao hÆ¡n
- JavaFX SDK
- Webcam (cho video call)
- Microphone (cho voice call)
- Network: LAN connection
- OS: Windows, macOS, Linux

### C. Port Usage Summary
| Service | Port Range | Protocol | Description |
|---------|-----------|----------|-------------|
| Discovery | 11000-11049 | TCP | Peer discovery (50 ports, dynamic) |
| Chat Server | 8888-9887 | TCP | Chat messages |
| File Server | 8890-9889 | TCP | File transfer |
| Voice Call | 9000-9999 | TCP | Voice streaming |
| Video Stream | 9500-10499 | TCP | Video data |
| Video Audio | 9600-10599 | TCP | Audio cho video call |
| Session Lock | 20000-39999 | TCP | NgÄƒn Ä‘Äƒng nháº­p trÃ¹ng (local) |

**Port Calculation**:
- Discovery: `11000 + abs(username.hashCode() % 50)`
- Chat: `8888 + abs(username.hashCode() % 1000)`
- File: `8890 + abs(username.hashCode() % 1000)`
- Voice: `9000 + abs(username.hashCode() % 1000)`
- Video: `9500 + abs(username.hashCode() % 1000)`
- Video Audio: `9600 + abs(username.hashCode() % 1000)`
- Session Lock: `20000 + abs(username.hashCode() % 20000)`

---

**TÃ¡c giáº£**: Äá»— Quá»‘c Phong
**NgÃ y**: 02/11/2025
**Version**: 1.0

---

## 12. CHI TIáº¾T Ká»¸ THUáº¬T Bá»” SUNG

### 12.1. Session Lock Manager
**Má»¥c Ä‘Ã­ch**: NgÄƒn cháº·n Ä‘Äƒng nháº­p trÃ¹ng láº·p trÃªn LAN

**CÆ¡ cháº¿**:
1. Local lock: Bind ServerSocket trÃªn localhost vá»›i port = 20000 + hash(username) % 20000
2. LAN check: Scan discovery port (11000-11049) cá»§a username trÃªn toÃ n bá»™ subnet
3. Náº¿u tÃ¬m tháº¥y discovery port Ä‘ang má»Ÿ â†’ user Ä‘Ã£ Ä‘Äƒng nháº­p trÃªn mÃ¡y khÃ¡c â†’ tá»« chá»‘i
4. Release lock khi Ä‘Äƒng xuáº¥t hoáº·c thoÃ¡t app

**Æ¯u Ä‘iá»ƒm**: 
- KhÃ´ng cáº§n database hoáº·c server trung tÃ¢m
- Táº­n dá»¥ng discovery port Ä‘Ã£ cÃ³ sáºµn
- Scan nhanh (chá»‰ 50 ports, timeout 3s)

### 12.2. Typing Indicators
**Protocol**:
- 1-1 chat: `TYPING`, `STOP_TYPING`
- Group chat: `GROUP_TYPING:groupName:username`, `GROUP_STOP_TYPING:groupName:username`

**Logic**:
- Gá»­i TYPING khi báº¯t Ä‘áº§u gÃµ (sau 3s khÃ´ng gÃµ tá»± Ä‘á»™ng gá»­i STOP_TYPING)
- Hiá»ƒn thá»‹ indicator trong 5 giÃ¢y, sau Ä‘Ã³ auto-hide
- Há»— trá»£ nhiá»u ngÆ°á»i Ä‘ang gÃµ trong group

### 12.3. Image Preview
**TÃ­nh nÄƒng**:
- Tá»± Ä‘á»™ng phÃ¡t hiá»‡n file áº£nh (jpg, jpeg, png, gif, bmp, webp)
- Hiá»ƒn thá»‹ preview trong chat (max 350x350, preserve ratio)
- Double-click Ä‘á»ƒ xem full size (má»Ÿ báº±ng default image viewer)
- Váº«n cÃ³ nÃºt download Ä‘á»ƒ lÆ°u file

### 12.4. Discovery Optimization
**Cáº£i tiáº¿n**:
- TrÆ°á»›c: Scan 1000 ports trÃªn 254 IPs = 254,000 káº¿t ná»‘i (ráº¥t cháº­m)
- Sau: 
  1. Ping scan Ä‘á»ƒ tÃ¬m active hosts (8s)
  2. Scan 50 discovery ports trÃªn active hosts (60s)
  3. Æ¯u tiÃªn scan localhost trÆ°á»›c
  4. ExecutorService vá»›i 50 threads Ä‘á»“ng thá»i

**Káº¿t quáº£**: Giáº£m thá»i gian scan tá»« vÃ i phÃºt xuá»‘ng cÃ²n 8-60 giÃ¢y

### 12.5. Audio Format Detection
**Váº¥n Ä‘á»**: Windows vÃ  Linux/Mac sá»­ dá»¥ng endianness khÃ¡c nhau

**Giáº£i phÃ¡p**: Auto-detect format Ä‘Æ°á»£c há»— trá»£
1. Thá»­ little-endian (Windows thÆ°á»ng dÃ¹ng)
2. Fallback sang big-endian (Linux/Mac)
3. Fallback cuá»‘i cÃ¹ng: unsigned little-endian

**Ãp dá»¥ng**: Video call audio (voice call dÃ¹ng fixed little-endian)

### 12.6. Noise Gate trong Voice Call
**Má»¥c Ä‘Ã­ch**: Giáº£m bandwidth vÃ  tiáº¿ng á»“n

**CÆ¡ cháº¿**:
- TÃ­nh RMS (Root Mean Square) cá»§a audio buffer
- Chá»‰ gá»­i náº¿u RMS > 500 (cÃ³ tiáº¿ng nÃ³i)
- Náº¿u khÃ´ng, gá»­i silence packet (Ä‘á»ƒ trÃ¡nh jitter)

**Káº¿t quáº£**: Giáº£m traffic vÃ  cáº£i thiá»‡n cháº¥t lÆ°á»£ng

### 12.7. Heartbeat Checker
**Má»¥c Ä‘Ã­ch**: PhÃ¡t hiá»‡n peer offline

**CÆ¡ cháº¿**:
- Cháº¡y má»—i 10 giÃ¢y
- Kiá»ƒm tra cÃ¡c peer khÃ´ng cÃ³ connection active
- Thá»­ káº¿t ná»‘i Ä‘áº¿n discovery port Ä‘á»ƒ verify
- Náº¿u khÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c â†’ remove khá»i danh sÃ¡ch

**LÆ°u Ã½**: Chá»‰ xÃ³a náº¿u khÃ´ng cÃ³ connection active vÃ  khÃ´ng thá»ƒ reconnect